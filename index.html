<!DOCTYPE html>
<html>
<head>
  <title>Slope Logic (Working)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f4f7f6;
      color: #333;
    }
    .hidden {
      display: none;
    }
    #playerContainer {
      position: relative;
      width: 100%;
      max-width: 720px;
      aspect-ratio: 16 / 9;
      margin: 20px auto;
      background-color: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    #resultsVideo, #resultsCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #resultsVideo { z-index: 1; }
    #resultsCanvas {
      z-index: 2;
      pointer-events: none; /* Allow clicks to pass through to video controls */
    }
  </style>
</head>
<body>
  <h1>AI Ski Coach</h1>
  <p>Upload your ski video. The AI analysis will appear when you press play.</p>
  <input type="file" id="videoUpload" accept="video/*">

  <div id="playerContainer" class="hidden">
    <video id="resultsVideo" controls></video>
    <canvas id="resultsCanvas"></canvas>
  </div>

  <div id="feedbackPanel" style="position: fixed; right: 20px; top: 80px; width: 320px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: 'Segoe UI', Arial, sans-serif; display: none;">
    <h2 style="margin: 0 0 20px 0; font-size: 22px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
      ðŸŽ¿ AI Coach Analysis
    </h2>
    <div id="overallScore" style="font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
      Overall: <span id="scoreValue" style="color: #4CAF50;">--</span>
    </div>
    <div id="feedbackList" style="line-height: 1.8;">
      <!-- Feedback items will appear here -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>

  <script>
    console.log('ðŸŸ¢ Script loaded successfully');

    // ============================================
    // IDEAL SKI FORM REFERENCE MODEL
    // ============================================
    const IDEAL_SKI_FORM = {
      kneeAngle: {
        min: 120,
        max: 145,
        unit: "degrees",
        description: "Athletic stance with proper knee flex"
      },
      hipPosition: {
        // Hip should be slightly forward - measured as horizontal offset
        minForward: 0,  // cm
        maxForward: 15,
        unit: "cm",
        description: "Hips slightly forward of shoulders for balance"
      },
      stanceWidth: {
        // As percentage of shoulder width
        minPercent: 95,
        maxPercent: 115,
        unit: "percent",
        description: "Approximately shoulder-width stance"
      },
      torsoAngle: {
        // Angle from vertical (0 = perfectly upright)
        min: 5,   // slightly forward lean
        max: 20,  // moderate forward lean
        unit: "degrees",
        description: "Slight forward lean in upper body"
      },
      weightDistribution: {
        // Left/right balance percentage (50 = perfectly centered)
        min: 45,
        max: 55,
        unit: "percent",
        description: "Centered weight between both feet"
      }
    };

    // ============================================
    // BIOMECHANICAL ANALYSIS FUNCTIONS
    // ============================================

    // Calculate angle between three points (in degrees)
    function calculateAngle(pointA, pointB, pointC) {
      const radians = Math.atan2(pointC.y - pointB.y, pointC.x - pointB.x) -
                      Math.atan2(pointA.y - pointB.y, pointA.x - pointB.x);
      let angle = Math.abs(radians * 180.0 / Math.PI);
      if (angle > 180.0) {
        angle = 360 - angle;
      }
      return angle;
    }

    // Calculate distance between two points
    function calculateDistance(pointA, pointB) {
      const dx = pointB.x - pointA.x;
      const dy = pointB.y - pointA.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // Analyze ski form and compare to ideal
    function analyzeSkiForm(landmarks) {
      // MediaPipe Pose landmark indices
      const LEFT_SHOULDER = 11;
      const RIGHT_SHOULDER = 12;
      const LEFT_HIP = 23;
      const RIGHT_HIP = 24;
      const LEFT_KNEE = 25;
      const RIGHT_KNEE = 26;
      const LEFT_ANKLE = 27;
      const RIGHT_ANKLE = 28;

      const feedback = [];

      // Helper function to calculate score based on how close value is to ideal range
      function calculateScore(value, min, max) {
        if (value >= min && value <= max) {
          return 100; // Perfect - within ideal range
        }
        const midpoint = (min + max) / 2;
        const tolerance = (max - min) / 2;
        const deviation = Math.abs(value - midpoint);
        const score = Math.max(0, 100 - (deviation / tolerance) * 50);
        return Math.round(score);
      }

      // 1. Calculate knee angles
      const leftKneeAngle = calculateAngle(
        landmarks[LEFT_HIP],
        landmarks[LEFT_KNEE],
        landmarks[LEFT_ANKLE]
      );
      const rightKneeAngle = calculateAngle(
        landmarks[RIGHT_HIP],
        landmarks[RIGHT_KNEE],
        landmarks[RIGHT_ANKLE]
      );

      const avgKneeAngle = (leftKneeAngle + rightKneeAngle) / 2;
      const kneeScore = calculateScore(avgKneeAngle, IDEAL_SKI_FORM.kneeAngle.min, IDEAL_SKI_FORM.kneeAngle.max);

      if (avgKneeAngle < IDEAL_SKI_FORM.kneeAngle.min) {
        feedback.push({
          category: "Knee Angle",
          emoji: avgKneeAngle < 110 ? "ðŸ”´" : "ðŸŸ¡",
          status: avgKneeAngle < 110 ? "error" : "warning",
          message: `Too much knee bend (${avgKneeAngle.toFixed(0)}Â°). Stand up slightly.`,
          score: kneeScore
        });
      } else if (avgKneeAngle > IDEAL_SKI_FORM.kneeAngle.max) {
        feedback.push({
          category: "Knee Angle",
          emoji: avgKneeAngle > 155 ? "ðŸ”´" : "ðŸŸ¡",
          status: avgKneeAngle > 155 ? "error" : "warning",
          message: `Legs too straight (${avgKneeAngle.toFixed(0)}Â°). Bend knees more.`,
          score: kneeScore
        });
      } else {
        feedback.push({
          category: "Knee Angle",
          emoji: "ðŸŸ¢",
          status: "good",
          message: `Perfect knee bend (${avgKneeAngle.toFixed(0)}Â°)`,
          score: kneeScore
        });
      }

      // 2. Calculate hip position (horizontal offset from shoulders)
      const leftShoulder = landmarks[LEFT_SHOULDER];
      const rightShoulder = landmarks[RIGHT_SHOULDER];
      const leftHip = landmarks[LEFT_HIP];
      const rightHip = landmarks[RIGHT_HIP];

      const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
      const hipMidX = (leftHip.x + rightHip.x) / 2;
      const hipOffset = (hipMidX - shoulderMidX) * 100; // Convert to percentage

      const hipScore = calculateScore(hipOffset, -5, 10);

      if (hipOffset < -5) {
        feedback.push({
          category: "Hip Position",
          emoji: hipOffset < -15 ? "ðŸ”´" : "ðŸŸ¡",
          status: hipOffset < -15 ? "error" : "warning",
          message: "Hips too far back. Move weight forward.",
          score: hipScore
        });
      } else if (hipOffset > 10) {
        feedback.push({
          category: "Hip Position",
          emoji: hipOffset > 20 ? "ðŸ”´" : "ðŸŸ¡",
          status: hipOffset > 20 ? "error" : "warning",
          message: "Hips too far forward. Shift weight back slightly.",
          score: hipScore
        });
      } else {
        feedback.push({
          category: "Hip Position",
          emoji: "ðŸŸ¢",
          status: "good",
          message: "Perfect hip alignment",
          score: hipScore
        });
      }

      // 3. Calculate stance width (as percentage of shoulder width)
      const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
      const ankleWidth = calculateDistance(landmarks[LEFT_ANKLE], landmarks[RIGHT_ANKLE]);
      const stanceWidthPercent = (ankleWidth / shoulderWidth) * 100;

      const stanceScore = calculateScore(stanceWidthPercent, IDEAL_SKI_FORM.stanceWidth.minPercent, IDEAL_SKI_FORM.stanceWidth.maxPercent);

      if (stanceWidthPercent < IDEAL_SKI_FORM.stanceWidth.minPercent) {
        feedback.push({
          category: "Stance Width",
          emoji: stanceWidthPercent < 80 ? "ðŸ”´" : "ðŸŸ¡",
          status: stanceWidthPercent < 80 ? "error" : "warning",
          message: "Stance too narrow. Widen your feet to shoulder width.",
          score: stanceScore
        });
      } else if (stanceWidthPercent > IDEAL_SKI_FORM.stanceWidth.maxPercent) {
        feedback.push({
          category: "Stance Width",
          emoji: stanceWidthPercent > 130 ? "ðŸ”´" : "ðŸŸ¡",
          status: stanceWidthPercent > 130 ? "error" : "warning",
          message: "Stance too wide. Bring feet closer together.",
          score: stanceScore
        });
      } else {
        feedback.push({
          category: "Stance Width",
          emoji: "ðŸŸ¢",
          status: "good",
          message: "Excellent stance width",
          score: stanceScore
        });
      }

      // 4. Calculate torso angle (lean from vertical)
      const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
      const hipMidY = (leftHip.y + rightHip.y) / 2;
      const torsoAngle = Math.atan2(Math.abs(hipMidX - shoulderMidX), Math.abs(hipMidY - shoulderMidY)) * 180 / Math.PI;

      const torsoScore = calculateScore(torsoAngle, IDEAL_SKI_FORM.torsoAngle.min, IDEAL_SKI_FORM.torsoAngle.max);

      if (torsoAngle < IDEAL_SKI_FORM.torsoAngle.min) {
        feedback.push({
          category: "Torso Angle",
          emoji: torsoAngle < 2 ? "ðŸ”´" : "ðŸŸ¡",
          status: torsoAngle < 2 ? "error" : "warning",
          message: "Too upright. Lean forward slightly for better control.",
          score: torsoScore
        });
      } else if (torsoAngle > IDEAL_SKI_FORM.torsoAngle.max) {
        feedback.push({
          category: "Torso Angle",
          emoji: torsoAngle > 30 ? "ðŸ”´" : "ðŸŸ¡",
          status: torsoAngle > 30 ? "error" : "warning",
          message: "Leaning too far forward. Stand up slightly.",
          score: torsoScore
        });
      } else {
        feedback.push({
          category: "Torso Angle",
          emoji: "ðŸŸ¢",
          status: "good",
          message: "Perfect forward lean",
          score: torsoScore
        });
      }

      // 5. Calculate weight distribution (left/right balance)
      const leftAnkle = landmarks[LEFT_ANKLE];
      const rightAnkle = landmarks[RIGHT_ANKLE];
      const ankleMidX = (leftAnkle.x + rightAnkle.x) / 2;
      const weightBalance = ((hipMidX - ankleMidX) / ankleWidth + 0.5) * 100;

      const weightScore = calculateScore(weightBalance, IDEAL_SKI_FORM.weightDistribution.min, IDEAL_SKI_FORM.weightDistribution.max);

      if (weightBalance < IDEAL_SKI_FORM.weightDistribution.min) {
        feedback.push({
          category: "Weight Distribution",
          emoji: weightBalance < 35 ? "ðŸ”´" : "ðŸŸ¡",
          status: weightBalance < 35 ? "error" : "warning",
          message: "Weight shifted to the left. Center your balance.",
          score: weightScore
        });
      } else if (weightBalance > IDEAL_SKI_FORM.weightDistribution.max) {
        feedback.push({
          category: "Weight Distribution",
          emoji: weightBalance > 65 ? "ðŸ”´" : "ðŸŸ¡",
          status: weightBalance > 65 ? "error" : "warning",
          message: "Weight shifted to the right. Center your balance.",
          score: weightScore
        });
      } else {
        feedback.push({
          category: "Weight Distribution",
          emoji: "ðŸŸ¢",
          status: "good",
          message: "Perfect weight balance",
          score: weightScore
        });
      }

      return feedback;
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸŸ¢ DOMContentLoaded - page ready');

      const videoUpload = document.getElementById('videoUpload');
      const playerContainer = document.getElementById('playerContainer');
      const resultsVideo = document.getElementById('resultsVideo');
      const resultsCanvas = document.getElementById('resultsCanvas');
      const feedbackPanel = document.getElementById('feedbackPanel');
      const scoreValue = document.getElementById('scoreValue');
      const feedbackList = document.getElementById('feedbackList');

      console.log('Elements found:', {
        videoUpload: !!videoUpload,
        playerContainer: !!playerContainer,
        resultsVideo: !!resultsVideo,
        resultsCanvas: !!resultsCanvas
      });

      console.log('ðŸŸ¡ Initializing MediaPipe Pose...');
      const pose = new Pose({
          locateFile: (file) => {
            const path = `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`;
            console.log('MediaPipe loading:', file);
            return path;
          }
      });
      pose.setOptions({
          modelComplexity: 1,
          smoothLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
      });
      pose.onResults(onResults);
      console.log('âœ… MediaPipe Pose initialized');

      videoUpload.addEventListener('change', (event) => {
          console.log('ðŸŸ¢ Upload button clicked - file selected');
          const file = event.target.files[0];
          if (file) {
              console.log('ðŸ“¹ File details:', {
                name: file.name,
                type: file.type,
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
              });
              playerContainer.classList.remove('hidden');
              resultsVideo.src = URL.createObjectURL(file);
              resultsVideo.load();
              console.log('âœ… Video source set, loading...');
          } else {
              console.log('âŒ No file selected');
          }
      });

      resultsVideo.addEventListener('loadeddata', () => {
          console.log('ðŸŸ¢ Video loaded successfully', {
            width: resultsVideo.videoWidth,
            height: resultsVideo.videoHeight,
            duration: resultsVideo.duration.toFixed(2) + 's'
          });
      });

      resultsVideo.addEventListener('play', () => {
          console.log('ðŸŸ¢ Play button clicked - video playing');
          feedbackPanel.style.display = 'block'; // Show feedback panel when video plays
          let frameCount = 0;
          const processVideo = async () => {
              if (resultsVideo.paused || resultsVideo.ended) {
                  console.log('â¸ï¸ Video stopped, ending processing');
                  return;
              }
              frameCount++;
              if (frameCount % 60 === 0) {
                console.log(`Processing frame ${frameCount} at ${resultsVideo.currentTime.toFixed(2)}s`);
              }
              await pose.send({ image: resultsVideo });
              requestAnimationFrame(processVideo);
          };
          requestAnimationFrame(processVideo);
      });

      resultsVideo.addEventListener('pause', () => {
          console.log('â¸ï¸ Video paused');
      });

      resultsVideo.addEventListener('error', (e) => {
          console.error('âŒ Video error:', e);
      });

      let resultsCount = 0;
      function onResults(results) {
          resultsCount++;
          if (resultsCount % 60 === 0) {
            console.log(`onResults called ${resultsCount} times, landmarks detected:`, !!results.poseLandmarks);
          }

          const canvasCtx = resultsCanvas.getContext('2d');
          resultsCanvas.width = resultsVideo.videoWidth;
          resultsCanvas.height = resultsVideo.videoHeight;
          canvasCtx.clearRect(0, 0, resultsCanvas.width, resultsCanvas.height);

          if (results.poseLandmarks) {
              // Draw skeleton
              window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 4 });
              window.drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#FF0000', radius: 2 });

              // Analyze ski form and update feedback panel (every 30 frames = ~1 second)
              if (resultsCount % 30 === 0) {
                const feedbackArray = analyzeSkiForm(results.poseLandmarks);

                // Calculate overall score (average of all metric scores)
                const totalScore = feedbackArray.reduce((sum, item) => sum + item.score, 0);
                const overallScore = Math.round(totalScore / feedbackArray.length);

                // Update score display with color coding
                scoreValue.textContent = overallScore + '%';
                if (overallScore >= 80) {
                  scoreValue.style.color = '#4CAF50'; // Green
                } else if (overallScore >= 60) {
                  scoreValue.style.color = '#FFC107'; // Yellow
                } else {
                  scoreValue.style.color = '#F44336'; // Red
                }

                // Update feedback list
                feedbackList.innerHTML = feedbackArray.map(item => {
                  const color = item.status === 'good' ? '#4CAF50' : (item.status === 'warning' ? '#FFC107' : '#F44336');
                  return `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid ${color};">
                      <div style="font-weight: bold; margin-bottom: 4px;">${item.emoji} ${item.category} <span style="float: right; font-size: 14px;">${item.score}%</span></div>
                      <div style="font-size: 14px; opacity: 0.9;">${item.message}</div>
                    </div>
                  `;
                }).join('');

                // Log to console as well
                console.log('ðŸ“Š Ski Form Analysis:');
                console.log('  Overall Score:', overallScore + '%');
                feedbackArray.forEach(item => {
                  console.log(`  ${item.emoji} ${item.category}: ${item.score}% - ${item.message}`);
                });
                console.log('---');
              }
          }
      }
    });
  </script>
</body>
</html>
