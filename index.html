<!DOCTYPE html>
<html>
<head>
  <title>Slope Logic (Working)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f4f7f6;
      color: #333;
    }
    .hidden {
      display: none;
    }
    #playerContainer {
      position: relative;
      width: 100%;
      max-width: 720px;
      aspect-ratio: 16 / 9;
      margin: 20px auto;
      background-color: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    #resultsVideo, #resultsCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #resultsVideo { z-index: 1; }
    #resultsCanvas {
      z-index: 2;
      pointer-events: none; /* Allow clicks to pass through to video controls */
    }
  </style>
</head>
<body>
  <h1>AI Ski Coach</h1>
  <p>Upload your ski video. The AI analysis will appear when you press play.</p>
  <input type="file" id="videoUpload" accept="video/*">

  <div id="playerContainer" class="hidden">
    <video id="resultsVideo" controls></video>
    <canvas id="resultsCanvas"></canvas>
  </div>

  <div id="feedbackPanel" style="position: fixed; right: 20px; top: 80px; width: 320px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-family: 'Segoe UI', Arial, sans-serif; display: none;">
    <h2 style="margin: 0 0 20px 0; font-size: 22px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
      🎿 AI Coach Analysis
    </h2>
    <div id="overallScore" style="font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
      Overall: <span id="scoreValue" style="color: #4CAF50;">--</span>
    </div>
    <div id="feedbackList" style="line-height: 1.8;">
      <!-- Feedback items will appear here -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>

  <script>
    console.log('🟢 Script loaded successfully');

    // ============================================
    // IDEAL SKI FORM REFERENCE MODEL
    // ============================================
    const IDEAL_SKI_FORM = {
      kneeAngle: {
        min: 120,
        max: 145,
        unit: "degrees",
        description: "Athletic stance with proper knee flex"
      },
      hipPosition: {
        // Hip should be slightly forward - measured as horizontal offset
        minForward: 0,  // cm
        maxForward: 15,
        unit: "cm",
        description: "Hips slightly forward of shoulders for balance"
      },
      stanceWidth: {
        // As percentage of shoulder width
        minPercent: 95,
        maxPercent: 115,
        unit: "percent",
        description: "Approximately shoulder-width stance"
      },
      torsoAngle: {
        // Angle from vertical (0 = perfectly upright)
        min: 5,   // slightly forward lean
        max: 20,  // moderate forward lean
        unit: "degrees",
        description: "Slight forward lean in upper body"
      },
      weightDistribution: {
        // Left/right balance percentage (50 = perfectly centered)
        min: 45,
        max: 55,
        unit: "percent",
        description: "Centered weight between both feet"
      }
    };

    // ============================================
    // BIOMECHANICAL ANALYSIS FUNCTIONS
    // ============================================

    // Calculate angle between three points (in degrees)
    function calculateAngle(pointA, pointB, pointC) {
      const radians = Math.atan2(pointC.y - pointB.y, pointC.x - pointB.x) -
                      Math.atan2(pointA.y - pointB.y, pointA.x - pointB.x);
      let angle = Math.abs(radians * 180.0 / Math.PI);
      if (angle > 180.0) {
        angle = 360 - angle;
      }
      return angle;
    }

    // Calculate distance between two points
    function calculateDistance(pointA, pointB) {
      const dx = pointB.x - pointA.x;
      const dy = pointB.y - pointA.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // Analyze ski form and compare to ideal
    function analyzeSkiForm(landmarks) {
      // MediaPipe Pose landmark indices
      const LEFT_SHOULDER = 11;
      const RIGHT_SHOULDER = 12;
      const LEFT_HIP = 23;
      const RIGHT_HIP = 24;
      const LEFT_KNEE = 25;
      const RIGHT_KNEE = 26;
      const LEFT_ANKLE = 27;
      const RIGHT_ANKLE = 28;
      const NOSE = 0;

      const analysis = {
        kneeAngle: { left: null, right: null },
        hipPosition: null,
        stanceWidth: null,
        torsoAngle: null,
        weightDistribution: null,
        feedback: []
      };

      // 1. Calculate knee angles
      const leftKneeAngle = calculateAngle(
        landmarks[LEFT_HIP],
        landmarks[LEFT_KNEE],
        landmarks[LEFT_ANKLE]
      );
      const rightKneeAngle = calculateAngle(
        landmarks[RIGHT_HIP],
        landmarks[RIGHT_KNEE],
        landmarks[RIGHT_ANKLE]
      );

      analysis.kneeAngle.left = leftKneeAngle.toFixed(1);
      analysis.kneeAngle.right = rightKneeAngle.toFixed(1);

      // Check knee angle feedback
      const avgKneeAngle = (leftKneeAngle + rightKneeAngle) / 2;
      if (avgKneeAngle < IDEAL_SKI_FORM.kneeAngle.min) {
        analysis.feedback.push({
          metric: "Knee Angle",
          status: "warning",
          message: `Too much knee bend (${avgKneeAngle.toFixed(0)}°). Stand up slightly.`
        });
      } else if (avgKneeAngle > IDEAL_SKI_FORM.kneeAngle.max) {
        analysis.feedback.push({
          metric: "Knee Angle",
          status: "warning",
          message: `Legs too straight (${avgKneeAngle.toFixed(0)}°). Bend knees more.`
        });
      } else {
        analysis.feedback.push({
          metric: "Knee Angle",
          status: "good",
          message: `Good knee flex (${avgKneeAngle.toFixed(0)}°)`
        });
      }

      // 2. Calculate hip position (horizontal offset from shoulders)
      const leftShoulder = landmarks[LEFT_SHOULDER];
      const rightShoulder = landmarks[RIGHT_SHOULDER];
      const leftHip = landmarks[LEFT_HIP];
      const rightHip = landmarks[RIGHT_HIP];

      const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
      const hipMidX = (leftHip.x + rightHip.x) / 2;
      const hipOffset = (hipMidX - shoulderMidX) * 100; // Convert to percentage

      analysis.hipPosition = hipOffset.toFixed(1);

      if (hipOffset < -5) {
        analysis.feedback.push({
          metric: "Hip Position",
          status: "warning",
          message: "Hips too far back. Move weight forward."
        });
      } else if (hipOffset > 10) {
        analysis.feedback.push({
          metric: "Hip Position",
          status: "warning",
          message: "Hips too far forward. Shift weight back slightly."
        });
      } else {
        analysis.feedback.push({
          metric: "Hip Position",
          status: "good",
          message: "Good hip position"
        });
      }

      // 3. Calculate stance width (as percentage of shoulder width)
      const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
      const ankleWidth = calculateDistance(landmarks[LEFT_ANKLE], landmarks[RIGHT_ANKLE]);
      const stanceWidthPercent = (ankleWidth / shoulderWidth) * 100;

      analysis.stanceWidth = stanceWidthPercent.toFixed(0);

      if (stanceWidthPercent < IDEAL_SKI_FORM.stanceWidth.minPercent) {
        analysis.feedback.push({
          metric: "Stance Width",
          status: "warning",
          message: "Stance too narrow. Widen your feet."
        });
      } else if (stanceWidthPercent > IDEAL_SKI_FORM.stanceWidth.maxPercent) {
        analysis.feedback.push({
          metric: "Stance Width",
          status: "warning",
          message: "Stance too wide. Bring feet closer together."
        });
      } else {
        analysis.feedback.push({
          metric: "Stance Width",
          status: "good",
          message: "Good stance width"
        });
      }

      // 4. Calculate torso angle (lean from vertical)
      const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
      const hipMidY = (leftHip.y + rightHip.y) / 2;
      const torsoAngle = Math.atan2(Math.abs(hipMidX - shoulderMidX), Math.abs(hipMidY - shoulderMidY)) * 180 / Math.PI;

      analysis.torsoAngle = torsoAngle.toFixed(1);

      if (torsoAngle < IDEAL_SKI_FORM.torsoAngle.min) {
        analysis.feedback.push({
          metric: "Torso Angle",
          status: "warning",
          message: "Too upright. Lean forward slightly."
        });
      } else if (torsoAngle > IDEAL_SKI_FORM.torsoAngle.max) {
        analysis.feedback.push({
          metric: "Torso Angle",
          status: "warning",
          message: "Leaning too far forward. Stand up slightly."
        });
      } else {
        analysis.feedback.push({
          metric: "Torso Angle",
          status: "good",
          message: "Good forward lean"
        });
      }

      // 5. Calculate weight distribution (left/right balance)
      const leftAnkle = landmarks[LEFT_ANKLE];
      const rightAnkle = landmarks[RIGHT_ANKLE];
      const ankleMidX = (leftAnkle.x + rightAnkle.x) / 2;
      const weightBalance = ((hipMidX - ankleMidX) / ankleWidth + 0.5) * 100;

      analysis.weightDistribution = weightBalance.toFixed(0);

      if (weightBalance < IDEAL_SKI_FORM.weightDistribution.min) {
        analysis.feedback.push({
          metric: "Weight Distribution",
          status: "warning",
          message: "Weight shifted to the left. Center your balance."
        });
      } else if (weightBalance > IDEAL_SKI_FORM.weightDistribution.max) {
        analysis.feedback.push({
          metric: "Weight Distribution",
          status: "warning",
          message: "Weight shifted to the right. Center your balance."
        });
      } else {
        analysis.feedback.push({
          metric: "Weight Distribution",
          status: "good",
          message: "Good weight balance"
        });
      }

      return analysis;
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('🟢 DOMContentLoaded - page ready');

      const videoUpload = document.getElementById('videoUpload');
      const playerContainer = document.getElementById('playerContainer');
      const resultsVideo = document.getElementById('resultsVideo');
      const resultsCanvas = document.getElementById('resultsCanvas');
      const feedbackPanel = document.getElementById('feedbackPanel');
      const scoreValue = document.getElementById('scoreValue');
      const feedbackList = document.getElementById('feedbackList');

      console.log('Elements found:', {
        videoUpload: !!videoUpload,
        playerContainer: !!playerContainer,
        resultsVideo: !!resultsVideo,
        resultsCanvas: !!resultsCanvas
      });

      console.log('🟡 Initializing MediaPipe Pose...');
      const pose = new Pose({
          locateFile: (file) => {
            const path = `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`;
            console.log('MediaPipe loading:', file);
            return path;
          }
      });
      pose.setOptions({
          modelComplexity: 1,
          smoothLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
      });
      pose.onResults(onResults);
      console.log('✅ MediaPipe Pose initialized');

      videoUpload.addEventListener('change', (event) => {
          console.log('🟢 Upload button clicked - file selected');
          const file = event.target.files[0];
          if (file) {
              console.log('📹 File details:', {
                name: file.name,
                type: file.type,
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB'
              });
              playerContainer.classList.remove('hidden');
              resultsVideo.src = URL.createObjectURL(file);
              resultsVideo.load();
              console.log('✅ Video source set, loading...');
          } else {
              console.log('❌ No file selected');
          }
      });

      resultsVideo.addEventListener('loadeddata', () => {
          console.log('🟢 Video loaded successfully', {
            width: resultsVideo.videoWidth,
            height: resultsVideo.videoHeight,
            duration: resultsVideo.duration.toFixed(2) + 's'
          });
      });

      resultsVideo.addEventListener('play', () => {
          console.log('🟢 Play button clicked - video playing');
          feedbackPanel.style.display = 'block'; // Show feedback panel when video plays
          let frameCount = 0;
          const processVideo = async () => {
              if (resultsVideo.paused || resultsVideo.ended) {
                  console.log('⏸️ Video stopped, ending processing');
                  return;
              }
              frameCount++;
              if (frameCount % 60 === 0) {
                console.log(`Processing frame ${frameCount} at ${resultsVideo.currentTime.toFixed(2)}s`);
              }
              await pose.send({ image: resultsVideo });
              requestAnimationFrame(processVideo);
          };
          requestAnimationFrame(processVideo);
      });

      resultsVideo.addEventListener('pause', () => {
          console.log('⏸️ Video paused');
      });

      resultsVideo.addEventListener('error', (e) => {
          console.error('❌ Video error:', e);
      });

      let resultsCount = 0;
      function onResults(results) {
          resultsCount++;
          if (resultsCount % 60 === 0) {
            console.log(`onResults called ${resultsCount} times, landmarks detected:`, !!results.poseLandmarks);
          }

          const canvasCtx = resultsCanvas.getContext('2d');
          resultsCanvas.width = resultsVideo.videoWidth;
          resultsCanvas.height = resultsVideo.videoHeight;
          canvasCtx.clearRect(0, 0, resultsCanvas.width, resultsCanvas.height);

          if (results.poseLandmarks) {
              // Draw skeleton
              window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 4 });
              window.drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#FF0000', radius: 2 });

              // Analyze ski form and update feedback panel (every 30 frames = ~1 second)
              if (resultsCount % 30 === 0) {
                const analysis = analyzeSkiForm(results.poseLandmarks);

                // Calculate overall score (percentage of metrics that are "good")
                const goodCount = analysis.feedback.filter(f => f.status === 'good').length;
                const totalCount = analysis.feedback.length;
                const overallScore = Math.round((goodCount / totalCount) * 100);

                // Update score display with color coding
                scoreValue.textContent = overallScore + '%';
                if (overallScore >= 80) {
                  scoreValue.style.color = '#4CAF50'; // Green
                } else if (overallScore >= 60) {
                  scoreValue.style.color = '#FFC107'; // Yellow
                } else {
                  scoreValue.style.color = '#F44336'; // Red
                }

                // Update feedback list
                feedbackList.innerHTML = analysis.feedback.map(item => {
                  const icon = item.status === 'good' ? '✅' : '⚠️';
                  const color = item.status === 'good' ? '#4CAF50' : '#FFC107';
                  return `
                    <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid ${color};">
                      <div style="font-weight: bold; margin-bottom: 4px;">${icon} ${item.metric}</div>
                      <div style="font-size: 14px; opacity: 0.9;">${item.message}</div>
                    </div>
                  `;
                }).join('');

                // Log to console as well
                console.log('📊 Ski Form Analysis:');
                console.log('  Overall Score:', overallScore + '%');
                console.log('  Knee Angle (L/R):', analysis.kneeAngle.left + '° / ' + analysis.kneeAngle.right + '°');
                console.log('  Hip Position:', analysis.hipPosition);
                console.log('  Stance Width:', analysis.stanceWidth + '%');
                console.log('  Torso Angle:', analysis.torsoAngle + '°');
                console.log('  Weight Distribution:', analysis.weightDistribution + '%');
                console.log('---');
              }
          }
      }
    });
  </script>
</body>
</html>
