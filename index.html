<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slope Logic - AI Ski Coach</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 50px;
      color: white;
    }

    .logo {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .tagline {
      font-size: 20px;
      opacity: 0.95;
      font-weight: 300;
    }

    /* Upload Section */
    .upload-section {
      background: white;
      border-radius: 20px;
      padding: 60px 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
      text-align: center;
    }

    .upload-title {
      font-size: 28px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .upload-subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 40px;
    }

    .upload-btn {
      display: inline-block;
      padding: 18px 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    input[type="file"] {
      display: none;
    }

    /* Video Player */
    .hidden {
      display: none !important;
    }

    #playerContainer {
      position: relative;
      width: 100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      margin: 0 auto 30px auto;
      background-color: #000;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    #resultsVideo, #resultsCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #resultsVideo { z-index: 1; }
    #resultsCanvas {
      z-index: 2;
      pointer-events: none;
    }

    /* Feedback Panel */
    #feedbackPanel {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      margin: 0 auto;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
      }
      .logo {
        font-size: 36px;
      }
      .tagline {
        font-size: 16px;
      }
      .upload-section {
        padding: 40px 20px;
      }
      .upload-title {
        font-size: 24px;
      }
      .upload-btn {
        padding: 15px 36px;
        font-size: 16px;
      }
      #feedbackPanel {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üéø Slope Logic</div>
      <div class="tagline">AI-Powered Ski Form Analysis</div>
    </div>

    <div class="upload-section">
      <h2 class="upload-title">Analyze Your Ski Technique</h2>
      <p class="upload-subtitle">Upload a video of your skiing and get professional-level feedback on your form</p>
      <label for="videoUpload" class="upload-btn">
        üìπ Choose Video File
      </label>
      <input type="file" id="videoUpload" accept="video/*">
    </div>

    <div id="playerContainer" class="hidden">
      <video id="resultsVideo" controls playsinline></video>
      <canvas id="resultsCanvas"></canvas>
    </div>

    <div id="feedbackPanel" style="display: none;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>

  <script>
    // ============================================
    // IDEAL SKI FORM REFERENCE MODEL
    // ============================================
    const IDEAL_SKI_FORM = {
      kneeAngle: {
        min: 148,
        max: 161,
        unit: "degrees",
        description: "Athletic stance with proper knee flex"
      },
      hipPosition: {
        minForward: -2.4,
        maxForward: 1.2,
        unit: "cm",
        description: "Hips slightly forward of shoulders for balance"
      },
      stanceWidth: {
        minPercent: 70,
        maxPercent: 84,
        unit: "percent",
        description: "Approximately shoulder-width stance"
      },
      torsoAngle: {
        min: 10,
        max: 16,
        unit: "degrees",
        description: "Slight forward lean in upper body"
      },
      weightDistribution: {
        min: 45,
        max: 55,
        unit: "percent",
        description: "Centered weight between both feet"
      }
    };

    // ============================================
    // BIOMECHANICAL ANALYSIS FUNCTIONS
    // ============================================

    function calculateAngle(pointA, pointB, pointC) {
      const radians = Math.atan2(pointC.y - pointB.y, pointC.x - pointB.x) -
                      Math.atan2(pointA.y - pointB.y, pointA.x - pointB.x);
      let angle = Math.abs(radians * 180.0 / Math.PI);
      if (angle > 180.0) {
        angle = 360 - angle;
      }
      return angle;
    }

    function calculateDistance(pointA, pointB) {
      const dx = pointB.x - pointA.x;
      const dy = pointB.y - pointA.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function extractMeasurements(landmarks) {
      const LEFT_SHOULDER = 11;
      const RIGHT_SHOULDER = 12;
      const LEFT_HIP = 23;
      const RIGHT_HIP = 24;
      const LEFT_KNEE = 25;
      const RIGHT_KNEE = 26;
      const LEFT_ANKLE = 27;
      const RIGHT_ANKLE = 28;

      // 1. Knee angles
      const leftKneeAngle = calculateAngle(
        landmarks[LEFT_HIP],
        landmarks[LEFT_KNEE],
        landmarks[LEFT_ANKLE]
      );
      const rightKneeAngle = calculateAngle(
        landmarks[RIGHT_HIP],
        landmarks[RIGHT_KNEE],
        landmarks[RIGHT_ANKLE]
      );
      const avgKneeAngle = (leftKneeAngle + rightKneeAngle) / 2;

      // 2. Hip position
      const leftShoulder = landmarks[LEFT_SHOULDER];
      const rightShoulder = landmarks[RIGHT_SHOULDER];
      const leftHip = landmarks[LEFT_HIP];
      const rightHip = landmarks[RIGHT_HIP];
      const shoulderMidX = (leftShoulder.x + rightShoulder.x) / 2;
      const hipMidX = (leftHip.x + rightHip.x) / 2;
      const hipOffset = (hipMidX - shoulderMidX) * 100;

      // 3. Stance width
      const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
      const leftAnkle = landmarks[LEFT_ANKLE];
      const rightAnkle = landmarks[RIGHT_ANKLE];
      const ankleWidth = calculateDistance(leftAnkle, rightAnkle);
      const stanceWidthPercent = (ankleWidth / shoulderWidth) * 100;

      // 4. Torso angle
      const shoulderMidY = (leftShoulder.y + rightShoulder.y) / 2;
      const hipMidY = (leftHip.y + rightHip.y) / 2;
      const torsoAngle = Math.atan2(Math.abs(hipMidX - shoulderMidX), Math.abs(hipMidY - shoulderMidY)) * 180 / Math.PI;

      // 5. Weight distribution
      const ankleRangeX = Math.abs(rightAnkle.x - leftAnkle.x);
      let weightBalance;
      if (ankleRangeX > 0.001) {
        const hipShiftFromLeft = hipMidX - leftAnkle.x;
        weightBalance = (hipShiftFromLeft / ankleRangeX) * 100;
        weightBalance = Math.max(0, Math.min(100, weightBalance));
      } else {
        weightBalance = 50;
      }

      return {
        kneeAngle: avgKneeAngle,
        hipPosition: hipOffset,
        stanceWidth: stanceWidthPercent,
        torsoAngle: torsoAngle,
        weightDistribution: weightBalance
      };
    }

    // ============================================
    // SUMMARY REPORT FUNCTIONS
    // ============================================

    function calculateScore(value, min, max, metricName = '') {
      if (value >= min && value <= max) {
        console.log(`‚úÖ ${metricName}: ${value.toFixed(1)} is in range [${min}, ${max}] ‚Üí Score: 100`);
        return 100;
      }

      const midpoint = (min + max) / 2;
      const tolerance = (max - min) / 2;
      const deviation = Math.abs(value - midpoint);
      const beyondRange = deviation - tolerance; // How far past the edge of the ideal range

      // Gradual scoring: lose 20 points per tolerance unit beyond the range
      // This means: 1 tolerance past edge = 80, 2 tolerances = 60, 3 = 40, 4 = 20, 5+ = 0
      const score = Math.max(0, 100 - (beyondRange / tolerance) * 20);

      console.log(`‚ö†Ô∏è ${metricName}: ${value.toFixed(1)} outside range [${min}, ${max}]`);
      console.log(`   Midpoint: ${midpoint.toFixed(1)}, Tolerance: ${tolerance.toFixed(1)}, Deviation: ${deviation.toFixed(1)}`);
      console.log(`   Beyond range: ${beyondRange.toFixed(1)}, Score: ${Math.round(score)}`);

      return Math.round(score);
    }

    function calculateStats(values) {
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const min = Math.min(...values);
      const max = Math.max(...values);

      const squaredDiffs = values.map(v => Math.pow(v - avg, 2));
      const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
      const stdDev = Math.sqrt(variance);

      return { avg, min, max, stdDev };
    }

    function analyzeAveragePerformance(measurements) {
      if (measurements.length === 0) return null;

      const summary = [];

      // Extract all values for each metric
      const kneeAngles = measurements.map(m => m.kneeAngle);
      const hipPositions = measurements.map(m => m.hipPosition);
      const stanceWidths = measurements.map(m => m.stanceWidth);
      const torsoAngles = measurements.map(m => m.torsoAngle);
      const weightDistributions = measurements.map(m => m.weightDistribution);

      // Calculate stats for each metric
      const kneeStats = calculateStats(kneeAngles);
      const hipStats = calculateStats(hipPositions);
      const stanceStats = calculateStats(stanceWidths);
      const torsoStats = calculateStats(torsoAngles);
      const weightStats = calculateStats(weightDistributions);

      // 1. Knee Angle Analysis
      const kneeScore = calculateScore(kneeStats.avg, IDEAL_SKI_FORM.kneeAngle.min, IDEAL_SKI_FORM.kneeAngle.max, 'Knee Angle');
      let kneeMessage = '';
      let kneeEmoji = '';
      let kneeStatus = '';

      if (kneeStats.avg < IDEAL_SKI_FORM.kneeAngle.min) {
        // Too much knee bend (squatting too low)
        kneeEmoji = kneeStats.avg < 140 ? "üî¥" : "üü°";
        kneeStatus = kneeStats.avg < 140 ? "error" : "warning";
        if (kneeStats.avg < 140) {
          kneeMessage = "Your knees are bent way too much - stand up taller! You shouldn't be squatting so low.";
        } else {
          kneeMessage = "Your knees are bent a bit too much - try standing up a little taller.";
        }
      } else if (kneeStats.avg > IDEAL_SKI_FORM.kneeAngle.max) {
        // Legs too straight
        kneeEmoji = kneeStats.avg > 170 ? "üî¥" : "üü°";
        kneeStatus = kneeStats.avg > 170 ? "error" : "warning";
        if (kneeStats.avg > 170) {
          kneeMessage = "Your knees are too straight - bend them more, like you're sitting on a chair!";
        } else {
          kneeMessage = "Your knees need a bit more flex - try bending them a little more.";
        }
      } else {
        kneeEmoji = "üü¢";
        kneeStatus = "good";
        kneeMessage = "Perfect knee bend! üí™ You kept your knees flexed just right throughout your run.";
      }

      summary.push({
        category: "Knee Bend",
        score: kneeScore,
        message: kneeMessage,
        emoji: kneeEmoji,
        status: kneeStatus,
        average: kneeStats.avg.toFixed(0) + "¬∞",
        range: `${kneeStats.min.toFixed(0)}-${kneeStats.max.toFixed(0)}¬∞`,
        consistency: kneeStats.stdDev.toFixed(1) + "¬∞",
        importance: 5  // Most important
      });

      // 2. Hip Position Analysis
      const hipScore = calculateScore(hipStats.avg, IDEAL_SKI_FORM.hipPosition.minForward, IDEAL_SKI_FORM.hipPosition.maxForward, 'Hip Position');
      let hipMessage = '';
      let hipEmoji = '';
      let hipStatus = '';

      if (hipStats.avg < IDEAL_SKI_FORM.hipPosition.minForward) {
        // Hips too far back
        hipEmoji = hipStats.avg < -10 ? "üî¥" : "üü°";
        hipStatus = hipStats.avg < -10 ? "error" : "warning";
        if (hipStats.avg < -10) {
          hipMessage = "You're leaning back too much - move your hips forward! Pretend you're reaching for something in front of you.";
        } else {
          hipMessage = "Try leaning forward just a bit more from your hips.";
        }
      } else if (hipStats.avg > IDEAL_SKI_FORM.hipPosition.maxForward) {
        // Hips too far forward
        hipEmoji = hipStats.avg > 10 ? "üî¥" : "üü°";
        hipStatus = hipStats.avg > 10 ? "error" : "warning";
        if (hipStats.avg > 10) {
          hipMessage = "You're leaning too far forward - stand up a bit straighter!";
        } else {
          hipMessage = "Stand up just a tiny bit straighter.";
        }
      } else {
        hipEmoji = "üü¢";
        hipStatus = "good";
        hipMessage = "Great balance! You stayed centered perfectly throughout your run.";
      }

      summary.push({
        category: "Balance",
        score: hipScore,
        message: hipMessage,
        emoji: hipEmoji,
        status: hipStatus,
        average: hipStats.avg.toFixed(1),
        range: `${hipStats.min.toFixed(1)} to ${hipStats.max.toFixed(1)}`,
        consistency: hipStats.stdDev.toFixed(1),
        importance: 2
      });

      // 3. Stance Width Analysis
      const stanceScore = calculateScore(stanceStats.avg, IDEAL_SKI_FORM.stanceWidth.minPercent, IDEAL_SKI_FORM.stanceWidth.maxPercent, 'Stance Width');
      let stanceMessage = '';
      let stanceEmoji = '';
      let stanceStatus = '';

      if (stanceStats.avg < IDEAL_SKI_FORM.stanceWidth.minPercent) {
        // Feet too close together
        stanceEmoji = stanceStats.avg < 60 ? "üî¥" : "üü°";
        stanceStatus = stanceStats.avg < 60 ? "error" : "warning";
        if (stanceStats.avg < 60) {
          stanceMessage = "Your feet are way too close together - stand wider, about shoulder-width apart!";
        } else {
          stanceMessage = "Your feet are a bit too close - try standing a little wider.";
        }
      } else if (stanceStats.avg > IDEAL_SKI_FORM.stanceWidth.maxPercent) {
        // Feet too far apart
        stanceEmoji = stanceStats.avg > 100 ? "üî¥" : "üü°";
        stanceStatus = stanceStats.avg > 100 ? "error" : "warning";
        if (stanceStats.avg > 100) {
          stanceMessage = "Your feet are too far apart - bring them closer together!";
        } else {
          stanceMessage = "Your feet are a bit too wide - bring them slightly closer together.";
        }
      } else {
        stanceEmoji = "üü¢";
        stanceStatus = "good";
        stanceMessage = "Perfect stance width! Your feet were just right - not too wide, not too narrow.";
      }

      summary.push({
        category: "Stance Width",
        score: stanceScore,
        message: stanceMessage,
        emoji: stanceEmoji,
        status: stanceStatus,
        average: stanceStats.avg.toFixed(0) + "%",
        range: `${stanceStats.min.toFixed(0)}-${stanceStats.max.toFixed(0)}%`,
        consistency: stanceStats.stdDev.toFixed(1) + "%",
        importance: 4
      });

      // 4. Torso Angle Analysis
      const torsoScore = calculateScore(torsoStats.avg, IDEAL_SKI_FORM.torsoAngle.min, IDEAL_SKI_FORM.torsoAngle.max, 'Torso Angle');
      let torsoMessage = '';
      let torsoEmoji = '';
      let torsoStatus = '';

      if (torsoStats.avg < IDEAL_SKI_FORM.torsoAngle.min) {
        // Too upright
        torsoEmoji = torsoStats.avg < 5 ? "üî¥" : "üü°";
        torsoStatus = torsoStats.avg < 5 ? "error" : "warning";
        if (torsoStats.avg < 5) {
          torsoMessage = "You're standing too straight up - lean forward more from your hips, like you're riding a bike!";
        } else {
          torsoMessage = "Lean forward a bit more from your hips - you're standing a little too upright.";
        }
      } else if (torsoStats.avg > IDEAL_SKI_FORM.torsoAngle.max) {
        // Leaning too far forward
        torsoEmoji = torsoStats.avg > 25 ? "üî¥" : "üü°";
        torsoStatus = torsoStats.avg > 25 ? "error" : "warning";
        if (torsoStats.avg > 25) {
          torsoMessage = "You're leaning way too far forward - stand up straighter!";
        } else {
          torsoMessage = "You're leaning a bit too far forward - stand up just a little straighter.";
        }
      } else {
        torsoEmoji = "üü¢";
        torsoStatus = "good";
        torsoMessage = "Nice forward lean! You kept your body in the perfect position.";
      }

      summary.push({
        category: "Forward Lean",
        score: torsoScore,
        message: torsoMessage,
        emoji: torsoEmoji,
        status: torsoStatus,
        average: torsoStats.avg.toFixed(0) + "¬∞",
        range: `${torsoStats.min.toFixed(0)}-${torsoStats.max.toFixed(0)}¬∞`,
        consistency: torsoStats.stdDev.toFixed(1) + "¬∞",
        importance: 1
      });

      // 5. Weight Distribution Analysis
      const weightScore = calculateScore(weightStats.avg, IDEAL_SKI_FORM.weightDistribution.min, IDEAL_SKI_FORM.weightDistribution.max, 'Weight Distribution');
      let weightMessage = '';
      let weightEmoji = '';
      let weightStatus = '';

      if (weightStats.avg < IDEAL_SKI_FORM.weightDistribution.min) {
        // Weight too far left
        weightEmoji = weightStats.avg < 35 ? "üî¥" : "üü°";
        weightStatus = weightStats.avg < 35 ? "error" : "warning";
        if (weightStats.avg < 35) {
          weightMessage = "You're leaning way too much to your left side - try to keep your weight centered between both feet!";
        } else {
          weightMessage = "You're leaning a bit to your left - try to stay more centered between both feet.";
        }
      } else if (weightStats.avg > IDEAL_SKI_FORM.weightDistribution.max) {
        // Weight too far right
        weightEmoji = weightStats.avg > 65 ? "üî¥" : "üü°";
        weightStatus = weightStats.avg > 65 ? "error" : "warning";
        if (weightStats.avg > 65) {
          weightMessage = "You're leaning way too much to your right side - try to keep your weight centered between both feet!";
        } else {
          weightMessage = "You're leaning a bit to your right - try to stay more centered between both feet.";
        }
      } else {
        weightEmoji = "üü¢";
        weightStatus = "good";
        weightMessage = "Perfect balance between both feet! You stayed centered throughout your run.";
      }

      summary.push({
        category: "Left-Right Balance",
        score: weightScore,
        message: weightMessage,
        emoji: weightEmoji,
        status: weightStatus,
        average: weightStats.avg.toFixed(0) + "%",
        range: `${weightStats.min.toFixed(0)}-${weightStats.max.toFixed(0)}%`,
        consistency: weightStats.stdDev.toFixed(1) + "%",
        importance: 3
      });

      return summary;
    }

    function displaySummaryReport(summary) {
      const feedbackPanel = document.getElementById('feedbackPanel');

      // Calculate overall score
      const overallScore = Math.round(summary.reduce((sum, item) => sum + item.score, 0) / summary.length);

      // Find issues (score < 70) and strengths (score >= 80)
      const issues = summary.filter(item => item.score < 70);
      const strengths = summary.filter(item => item.status === 'good');

      // Sort issues by importance (higher importance first)
      const sortedIssues = [...issues].sort((a, b) => b.importance - a.importance);

      // Determine what to show
      let focusItems = [];
      let isFineTuning = false;

      if (issues.length === 0) {
        // All scores above 80 - show fine-tuning mode
        isFineTuning = true;
        const sortedByScore = [...summary].sort((a, b) => a.score - b.score);
        focusItems = [sortedByScore[0]]; // Show lowest scoring metric
      } else if (issues.length === 1) {
        focusItems = [sortedIssues[0]];
      } else {
        // 2+ issues - show top 2 by importance
        focusItems = sortedIssues.slice(0, 2);
      }

      // Build HTML
      let html = `
        <div style="max-width: 700px; margin: 0 auto;">
          <div style="text-align: center; padding: 20px 0; border-bottom: 2px solid #ddd; margin-bottom: 30px;">
            <div style="font-size: 14px; color: #888; letter-spacing: 2px; margin-bottom: 10px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
            <h2 style="margin: 0; font-size: 28px; color: #333; font-weight: 700;">üìä YOUR RESULTS</h2>
            <div style="font-size: 14px; color: #888; letter-spacing: 2px; margin-top: 10px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
          </div>

          <div style="text-align: center; margin-bottom: 35px;">
            <div style="font-size: 42px; font-weight: 800; color: ${overallScore >= 80 ? '#4caf50' : overallScore >= 60 ? '#ff9800' : '#f44336'}; margin-bottom: 5px;">
              ${overallScore}/100
            </div>
            <div style="font-size: 14px; color: #666;">Overall Score</div>
          </div>

          <div style="margin-bottom: 35px;">
            <h3 style="font-size: 22px; margin: 0 0 20px 0; color: ${isFineTuning ? '#2196F3' : '#f44336'}; font-weight: 700;">
              ${isFineTuning ? 'üéØ FINE-TUNE THIS:' : 'üéØ FOCUS ON THIS:'}
            </h3>

            ${focusItems.map((item, index) => `
              <div style="margin-bottom: 20px; padding: 25px; background: ${isFineTuning ? '#e3f2fd' : '#fff5f5'}; border-radius: 15px; border-left: 5px solid ${isFineTuning ? '#2196F3' : '#f44336'};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <div style="font-size: 20px; font-weight: 700; color: #333;">
                    ${focusItems.length > 1 ? `${index + 1}. ` : ''}${item.category}
                  </div>
                  <div style="font-size: 22px; font-weight: 700; color: ${isFineTuning ? '#2196F3' : '#f44336'};">
                    ${item.score}/100
                  </div>
                </div>
                <div style="font-size: 16px; line-height: 1.6; color: #444;">
                  ${item.message}
                  ${index === 0 && !isFineTuning ? ' <strong style="color: #f44336;">This is the most important thing to work on right now!</strong>' : ''}
                  ${isFineTuning ? ' <strong style="color: #2196F3;">You\'re doing great! Just polish this a bit more.</strong>' : ''}
                </div>
              </div>
            `).join('')}

            ${isFineTuning ? '' : '<div style="font-size: 15px; color: #888; font-style: italic; margin-top: 15px; padding-left: 10px;">üí° Fix this first, then we\'ll work on the next level!</div>'}
          </div>

          ${strengths.length > 0 ? `
            <div style="margin-bottom: 35px;">
              <h3 style="font-size: 20px; margin: 0 0 15px 0; color: #4caf50; font-weight: 700;">‚úÖ WHAT YOU'RE DOING WELL:</h3>
              <div style="background: #f1f8f4; border-radius: 15px; padding: 20px; border-left: 5px solid #4caf50;">
                ${strengths.map(item => `
                  <div style="margin-bottom: 8px; font-size: 16px; color: #333;">
                    ‚Ä¢ ${item.message.replace(/! üí™/, '!').replace(/!/g, '')}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px; color: white;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">üí° TIP:</div>
            <div style="font-size: 15px; line-height: 1.6;">
              ${isFineTuning
                ? 'You\'re doing awesome! Keep practicing and you\'ll be even better. Upload another video to track your progress!'
                : 'Upload another video after practicing to get more specific feedback and unlock the next level!'}
            </div>
          </div>

          <button onclick="location.reload()" style="width: 100%; padding: 18px; background: white; color: #667eea; border: 3px solid #667eea; border-radius: 50px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
            üîÑ Analyze Another Video
          </button>
        </div>
      `;

      feedbackPanel.innerHTML = html;
      feedbackPanel.style.display = 'block';
    }

    // ============================================
    // MAIN APPLICATION LOGIC
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      const videoUpload = document.getElementById('videoUpload');
      const playerContainer = document.getElementById('playerContainer');
      const resultsVideo = document.getElementById('resultsVideo');
      const resultsCanvas = document.getElementById('resultsCanvas');
      const feedbackPanel = document.getElementById('feedbackPanel');

      let allMeasurements = [];

      const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      pose.onResults(onResults);

      videoUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          allMeasurements = [];
          feedbackPanel.style.display = 'none';
          playerContainer.classList.remove('hidden');
          resultsVideo.src = URL.createObjectURL(file);
          resultsVideo.load();
        }
      });

      resultsVideo.addEventListener('play', () => {
        const processVideo = async () => {
          if (resultsVideo.paused || resultsVideo.ended) return;
          await pose.send({ image: resultsVideo });
          requestAnimationFrame(processVideo);
        };
        requestAnimationFrame(processVideo);
      });

      resultsVideo.addEventListener('ended', () => {
        if (allMeasurements.length > 0) {
          const summary = analyzeAveragePerformance(allMeasurements);
          displaySummaryReport(summary);
        }
      });

      let resultsCount = 0;
      function onResults(results) {
        resultsCount++;

        const canvasCtx = resultsCanvas.getContext('2d');
        resultsCanvas.width = resultsVideo.videoWidth;
        resultsCanvas.height = resultsVideo.videoHeight;
        canvasCtx.clearRect(0, 0, resultsCanvas.width, resultsCanvas.height);

        if (results.poseLandmarks) {
          window.drawConnectors(canvasCtx, results.poseLandmarks, window.POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 4 });
          window.drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#FF0000', radius: 2 });

          if (resultsCount % 30 === 0) {
            const measurements = extractMeasurements(results.poseLandmarks);
            allMeasurements.push(measurements);
          }
        }
      }
    });
  </script>
</body>
</html>
